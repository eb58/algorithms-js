<!doctype html>
<html lang="de">
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
    <title>Mandelbrot</title>
  </head>

  <body>
    <canvas id="myCanvas" width="1000" height="1000"></canvas>
    <p style="text-align: center">Click the image to zoom in</p>
    <script>
      const range = (n) => [...Array(n).keys()]

      const canvas = document.getElementById('myCanvas')
      const { width, height } = canvas
      const ctx = canvas.getContext('2d')
      const canvasData = ctx.getImageData(0, 0, width, height)

      const setPixel = (x, y, rgb) => rgb.forEach((n, idx) => (canvasData.data[(x + y * width) * 4 + idx] = n))

      const worker = new Worker('mandelbrot.worker.js')

      let [topLeft, bottomRight] = [
        { r: -2.05, i: 1.15 },
        { r: 0.6, i: -1.15 }
      ]
      let maxIterations = 100

      const startWorker = (topLeft, bottomRight) => {
        const [dx, dy] = [(bottomRight.r - topLeft.r) / width, (bottomRight.i - topLeft.i) / height]
        const pixels = range(width).map((x) => range(height).map((y) => ({ r: topLeft.r + x * dx, i: topLeft.i + y * dy })))
        worker.postMessage({ pixels, maxIterations })
        worker.onmessage = (data) => {
          data.data.forEach((r, ri) => r.forEach((c, ci) => setPixel(ri, ci, c)))
          ctx.putImageData(canvasData, 0, 0)
        }
      }

      const zoom = (event, factor = 3) => {
        const getRelativePoint = (pixel, s, e, d) => s + (pixel / d) * (e - s)
        const [w, h] = [(bottomRight.r - topLeft.r) / factor, (bottomRight.i - topLeft.i) / factor]
        const center = {
          r: getRelativePoint(event.offsetX, topLeft.r, bottomRight.r, width),
          i: getRelativePoint(event.offsetY, topLeft.i, bottomRight.i, height)
        }
        startWorker({ r: center.r - w / 2, i: center.i - h / 2 }, { r: center.r + w / 2, i: center.i + h / 2 })
      }

      canvas.addEventListener('click', (e) => zoom(e, 3))
      canvas.addEventListener('contextmenu', (e) => {
        e.preventDefault()
        zoom(e, 1 / 3)
      })

      startWorker(topLeft, bottomRight)
    </script>
  </body>
</html>
