<!doctype html>
<html lang="de">
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
    <title>Mandelbrot</title>
  </head>
  <style>
    button {
      font-size: 24px;
      margin: 5px 0 20px 0;
    }
  </style>
  <body>
    <div style="width: 800px; margin: 10px">
      <h1>Mandelbrot Set Viewer</h1>
      <canvas id="myCanvas" width="800" height="800"></canvas>
      <div id="controls">
        <button onclick="resetView()">Zur√ºcksetzen</button>
        <button onclick="changeColScheme()">Farbschema</button>
        <label for="iterSlider">Iterationen</label>
        <input onchange="changeIteration(this.value)" type="range" min="100" max="2000" value="100" id="iterSlider" />
        <span id="iterations">100</span>
      </div>
      <p style="text-align: center">Click the image to zoom in</p>
      <p style="text-align: center">Zoom: <span id="zoomLevel">1.0</span>x </p>
    </div>
    <script>
      const range = (n) => [...Array(n).keys()]
      const timer = (start = performance.now()) => ({ elapsedTime: () => ((performance.now() - start) / 1000).toFixed(3) })
      const rand255 = () => Math.floor(Math.random() * 255)

      const COLORS = range(100).map(() => Uint8ClampedArray.from([rand255(), rand255(), rand255(), 255]))
      const canvas = document.getElementById('myCanvas')
      const { width, height } = canvas
      const ctx = canvas.getContext('2d')
      const imageData = ctx.getImageData(0, 0, width, height)

      const initialView = {
        centerX: -0.75,
        centerY: 0,
        width: 2.55,
        maxIterations: 100,
        zoomFactor: 1,
        colorScheme: 1
      }
      let view = { ...initialView }

      let N_CHUNKS = 16
      let RECEIVED_CHUNKS = 0
      let t = timer()
      const workers = range(N_CHUNKS).map(() => {
        const worker = new Worker('mandelbrot.worker.js')
        worker.onmessage = (msg) => {
          imageData.data.set(msg.data.chunkImageData, msg.data.startRow * width * 4)
          if (++RECEIVED_CHUNKS === N_CHUNKS) {
            console.log('finished', t.elapsedTime())
            ctx.putImageData(imageData, 0, 0)
          }
        }
        return worker
      })

      const computeMandelbrot = () => {
        updateInfo()
        t = timer()
        RECEIVED_CHUNKS = 0

        const rowsPerChunk = Math.trunc(height / N_CHUNKS) // rows per chunk
        for (let n = 0; n < N_CHUNKS; n++) {
          const startRow = n * rowsPerChunk
          const endRow = Math.min(height, startRow + rowsPerChunk)
          workers[n].postMessage({ n, view, width, height, startRow, endRow, COLORS })
        }
      }

      const zoom = (event) => {
        const factor = event.ctrlKey ? 2 : 0.5
        const rect = canvas.getBoundingClientRect()
        const x = event.clientX - rect.left
        const y = event.clientY - rect.top
        view.width *= factor
        view.centerX = view.centerX + ((x - width / 2) * view.width) / width
        view.centerY = view.centerY + ((y - height / 2) * view.width) / width
        view.zoomFactor /= factor
        computeMandelbrot()
      }

      // UI actions
      canvas.addEventListener('click', (e) => zoom(e))
      const resetView = () => ((view = { ...initialView }), computeMandelbrot())
      const changeColScheme = () => ((view.colorScheme = 3 - view.colorScheme), computeMandelbrot())
      const changeIteration = (val) => (view.maxIterations = val, computeMandelbrot())
      const updateInfo = () => {
        document.getElementById('zoomLevel').textContent = view.zoomFactor
        document.getElementById('iterations').textContent = view.maxIterations
      }

      computeMandelbrot()
    </script>
  </body>
</html>
