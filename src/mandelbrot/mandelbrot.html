<!doctype html>
<html lang="de">
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
    <title>Mandelbrot</title>
  </head>

  <body>
    <canvas id="myCanvas" width="1200" height="1200"></canvas>
    <p style="text-align: center">Click the image to zoom in</p>
    <script>
      const range = (n) => [...Array(n).keys()]

      const canvas = document.getElementById('myCanvas')
      const { width, height } = canvas
      const canvasData = canvas.getContext('2d').getImageData(0, 0, width, height)

      const setPixel = (x, y, rgb) => rgb.forEach((n, idx) => (canvasData.data[(x + y * width) * 4 + idx] = n))

      const worker = new Worker('mandelbrot.worker.js')

      let [topLeft, bottomRight] = [
        { r: -2.05, i: 1.15 },
        { r: 0.6, i: -1.15 }
      ]

      canvas.addEventListener('click', (e) => {
        const ZOOM_FACTOR = 0.2
        const getRelativePoint = (pixel, s, e, d) => s + (pixel / d) * (e - s)
        const [w, h] = [(bottomRight.r - topLeft.r) * ZOOM_FACTOR, (bottomRight.i - topLeft.i) * ZOOM_FACTOR]
        const center = {
          r: getRelativePoint(e.offsetX, topLeft.r, bottomRight.r, width),
          i: getRelativePoint(e.offsetY, topLeft.i, bottomRight.i, height)
        }
        topLeft = { r: center.r - w / 2, i: center.i - h / 2 }
        bottomRight = { r: center.r + w / 2, i: center.i + h / 2 }
        startWorker()
      })

      const startWorker = () => {
        worker.postMessage({ topLeft, bottomRight, width, height })
        worker.onmessage = (data) => {
          data.data.forEach((r, ri) => r.forEach((c, ci) => setPixel(ri, ci, c)))
          canvas.getContext('2d').putImageData(canvasData, 0, 0)
        }
      }
      startWorker()
    </script>
  </body>
</html>
